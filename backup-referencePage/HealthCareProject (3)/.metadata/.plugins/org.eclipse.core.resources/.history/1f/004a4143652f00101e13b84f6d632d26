package testClasses;
import java.awt.AWTException;
import java.time.Duration;
import java.util.List;

import org.openqa.selenium.Alert;
import org.openqa.selenium.By;
import org.openqa.selenium.NoSuchElementException;
import org.openqa.selenium.WebDriver;
import org.openqa.selenium.WebElement;
import org.openqa.selenium.support.ui.ExpectedConditions;
import org.openqa.selenium.support.ui.FluentWait;
import org.openqa.selenium.support.ui.WebDriverWait;
import org.testng.Assert;
import org.testng.annotations.Test;

import pageClasses.PatientEndVisitPage;
import utilities.BaseClass;

public class PatientEndVisitTest extends BaseClass
{
	@Test(priority=2,groups={"sanity"},retryAnalyzer = utilities.RetryAnalyzer.class)
	public static void excuteEndVsistPatient() throws InterruptedException, AWTException
	{
	
		LoginTest.executeLoginTest();
		Thread.sleep(10000);

		scrollToTableHeader(driver);

		addExplicitWait3(PatientEndVisitPage.clickPatName());
		driver.findElement(PatientEndVisitPage.clickPatName()).click();
		
		scrollToTop(driver);
		Thread.sleep(3000);
		/*  elementToBeClickable */
//		addExplicitWait_elementclickable(PatientEndVisitPage.clickOnActions());
//		driver.findElement(PatientEndVisitPage.clickOnActions()).click();
		
		
//		WebDriverWait wait = new WebDriverWait(driver, Duration.ofSeconds(50));
//		WebElement button = wait.until(ExpectedConditions.elementToBeClickable(PatientEndVisitPage.clickOnActions()));
//		button.click();

		// Then, wait for aria-expanded='true' if needed
		//wait.until(ExpectedConditions.attributeToBe(button, "aria-expanded", "false"));
			
		/* Pause to allow dropdown to open */
//	    Thread.sleep(4000);
//		PatientEndVisitPage.selectOptionActions();
		
		// Step 1: Click the Actions button
		WebDriverWait wait = new WebDriverWait(driver, Duration.ofSeconds(50));
		WebElement actionsButton = wait.until(ExpectedConditions.elementToBeClickable(PatientEndVisitPage.clickOnActions()));
		actionsButton.click();
		// Step 2: Wait for one of the menu items to appear (e.g., "End active visit")
		By addVisitOption = By.xpath("//div[contains(@class, 'cds--overflow-menu-options__option-content') and text()='End active visit']");
		wait.until(ExpectedConditions.visibilityOfElementLocated(addVisitOption));
		
	
		// Step 3: Optionally click it
		driver.findElement(addVisitOption).click();
		
		
		
	// Wait for the alert to appear
		WebDriverWait(driver, 20).until(ExpectedConditions.alertIsPresent());

	// Now handle the alert
		Alert alert = driver.switchTo().alert();
		alert.accept() ;    //    or alert.dismiss()
		
		// Ensure Table View is selected
        WebElement tableViewBtn = driver.findElement(By.cssSelector("button[aria-label='Table view']"));
        if (!tableViewBtn.getAttribute("aria-selected").equals("true")) {
        	
        	tableViewBtn.click();
        }
        // Wait for table to load
        WebDriverWait wait1 = new WebDriverWait(driver, Duration.ofSeconds(30));
        WebElement table = wait1.until(ExpectedConditions.visibilityOfElementLocated(By.xpath("//table[@aria-label='vitals']")));

        // Get the  row
        List<WebElement> rows = table.findElements(By.xpath(".//tr"));
//        if (rows.isEmpty()) {
//            throw new NoSuchElementException("No rows found in vitals table.");
//        }
//		
        Assert.assertTrue(!(rows.isEmpty()),"No rows found in vitals table.");
		Thread.sleep(10000);
		
	}

	private static FluentWait<WebDriver> WebDriverWait(WebDriver driver, int i) {
		// TODO Auto-generated method stub
		return null;
	}
	
}
